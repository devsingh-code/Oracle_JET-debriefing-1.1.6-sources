"use strict";define(["signals"],e=>{const t=1;return class{constructor(){window.addEventListener("message",this.onPostMessage.bind(this),!1),this.debugMessageSentSignal=new e,this.debugMessageReceivedSignal=new e,this.debugIncorrectMessageReceivedSignal=new e,this.messageFromOfscSignal=new e,this._currentCommunicationCallback=null,this._currentCommunicationPromise=null}sendMessage(e){return this._currentCommunicationPromise?Promise.reject(new Error("Communication chanel is busy")):(this._currentCommunicationPromise=new Promise((n,i)=>{let r=document.referrer||document.location.ancestorOrigins&&document.location.ancestorOrigins[0]||"";if(!r)return i("Unable to get referrer");this._currentCommunicationCallback=(e=>(this._currentCommunicationCallback=null,this._currentCommunicationPromise=null,e instanceof Error?i(e):e.method&&"error"===e.method?i(e):n(e))),e.apiVersion=t,parent.postMessage(e,this.constructor._getOrigin(r)),this.debugMessageSentSignal.dispatch(e)}),this._currentCommunicationPromise)}onPostMessage(e){if(e.source===window)return;if(void 0===e.data)return this.debugIncorrectMessageReceivedSignal.dispatch("No data"),!!this._currentCommunicationCallback&&void this._currentCommunicationCallback(new Error("No data"));let t;try{t=JSON.parse(e.data)}catch(t){return this._currentCommunicationCallback?void this._currentCommunicationCallback(new Error("Incorrect JSON")):(this.debugIncorrectMessageReceivedSignal.dispatch("Incorrect JSON",e.data),!1)}this.debugMessageReceivedSignal.dispatch(t),this._currentCommunicationCallback?this._currentCommunicationCallback(t):this.messageFromOfscSignal.dispatch(t)}static generateCallId(){return btoa(String.fromCharCode.apply(null,window.crypto.getRandomValues(new Uint8Array(16))))}static _getOrigin(e){return"string"==typeof e&&""!==e?e.indexOf("://")>-1?(window.location.protocol||"https:")+e.split("/")[2]:(window.location.protocol||"https:")+e.split("/")[0]:""}}});