define(["ojs/ojcore","knockout","./ofsc-connector","./services/inventory-search-service","./data-services/parts-catalog-data-service","./models/catalog-collection","text!required-properties.json","ojs/ojmodel","./errors/application-critical-error","./components/index","ojs/ojrouter","ojs/ojvalidation-datetime","viewModels/add-expense","viewModels/add-labor","viewModels/add-returned-part","viewModels/add-used-part","viewModels/dashboard","viewModels/invoice","viewModels/service-checklist","text!views/service-checklist.html","text!views/add-expense.html","text!views/add-labor.html","text!views/add-returned-part.html","text!views/add-used-part.html","text!views/dashboard.html","text!views/invoice.html"],function(e,t,i,n,r,s,o,a,l){const d="inventory",c="part",v="part_sn",u="labor",p="expense",h="delete";function m(e){return{entity:d,action:h,invid:e.recordId}}return class{constructor(){this.router=this.getRouterInstance(),this.router.configure({dashboard:{label:"Dashboard",isDefault:!0},"add-labor":{label:"Add Labor"},"add-expense":{label:"Add Expense"},"add-used-part":{label:"Add Used Part"},"add-returned-part":{label:"Add Returned Part"},"service-checklist":{label:"Service Checklist"},invoice:{label:"Invoice"}}),e.Router.defaults.urlAdapter=new e.Router.urlParamAdapter,this.router.moduleConfig.params.app=this,this.dateTimeConverter=e.Validation.converterFactory("datetime").createConverter(),this.openData=t.observable(""),this._initModels(),this.dialogHeading=t.observable(""),this.dialogMessage=t.observable(""),this.ofscConnector=new i,this.ofscConnector.debugMessageReceivedSignal.add(e=>{console.info("-> DEBRIEFING: ",e)}),this.ofscConnector.debugMessageSentSignal.add(e=>{console.info("<- DEBRIEFING: ",e)}),this.ofscConnector.debugIncorrectMessageReceivedSignal.add((e,t)=>{console.error("-> DEBRIEFING: incorrect message: ",e,t)})}getRouterInstance(){return e.Router.rootInstance}getInvTypePartConst(){return c}getInvTypePartSnConst(){return v}getLogoUrl(){return this.logoUrl}terminatePlugin(){this.ofscConnector.sendMessage({method:"close"}).then(e=>{console.log("RESPONSE DATA: ",e)}).catch(e=>{console.error(e)})}load(){return new Promise((e,t)=>{console.log("Load is being called"),this.ofscConnector.sendMessage({method:"ready",sendInitData:!0}).then(t=>{switch(t.method){case"init":let i=t.attributeDescription;window.localStorage.setItem("debriefing_attributeDescription",JSON.stringify(i)),this.ofscConnector.sendMessage({method:"initEnd"});break;case"open":console.log("Message in case open"+t),this.openData(t),this.attributeDescription=JSON.parse(window.localStorage.getItem("debriefing_attributeDescription"));let n=this._verifyProperties(o,this.attributeDescription);if(""!==n)throw new l("Critical Error",n);if("started"!==t.activity.astatus)throw new l("Critical Error","The queue must be activated and the activity must be started. The plugin will be terminated.");if("activity"!==t.entity)throw new l("Critical Error","The plugin should be opened from an activity page. The plugin will be terminated.");this.loadData().then(()=>{this.open()}).then(e);break;case"error":this._showErrorAlert(t)}}).catch(e=>{if(e instanceof l)return t(e);console.error("Unable to start application: ",e)})})}loadData(){return console.log("LoadData is being called"),this.partsCatalogDataService=new r(this.ofscConnector),this.catalogCollection=new s,this.partsCatalogDataService.getPartsCatalogsStructure().then(e=>{e.forEach(e=>{this.catalogCollection.add(e)})})}_initModels(){this.laborItems=t.observableArray([]),this.expenseItems=t.observableArray([]),this.serialNums=t.observableArray([]),this.logoUrl=t.observable(""),this.partModelConstructor=e.Model.extend({idAttribute:"part_item_number"}),this.resourcePartsCollection=new a.Collection(null,{model:this.partModelConstructor}),this.createdDeinstalledPartsCollection=new a.Collection(null,{model:this.partModelConstructor}),this.customerPartsCollection=new a.Collection(null,{model:this.partModelConstructor}),this.usedPartsCollection=new a.Collection(null,{model:this.partModelConstructor}),this.returnedPartsCollection=new a.Collection(null,{model:this.partModelConstructor}),this.partsInventoryActionsCollection=new a.Collection}open(){console.log("Open is being called");let t=[];Object.entries(this.attributeDescription.labor_service_activity.enum).forEach(([e,{text:i,inactive:n}])=>{n||t.push({id:e,text:i})}),this.laborActivityEnumCollection=new a.Collection(t);let i=[];Object.entries(this.attributeDescription.labor_item_number.enum).forEach(([e,{text:t,inactive:n}])=>{n||i.push({id:e,label:t,text:this.attributeDescription.labor_item_desc.enum[e]?this.attributeDescription.labor_item_desc.enum[e].text:""})}),this.laborItemEnumCollection=new a.Collection(i);let r=[];Object.entries(this.attributeDescription.expense_service_activity.enum).forEach(([e,{text:t,inactive:i}])=>{i||r.push({id:e,text:t})}),this.expenseActivityEnumCollection=new a.Collection(r);let s=[];Object.entries(this.attributeDescription.expense_item_number.enum).forEach(([e,{text:t,inactive:i}])=>{i||s.push({id:e,label:t,text:this.attributeDescription.expense_item_desc.enum[e]?this.attributeDescription.expense_item_desc.enum[e].text:""})}),this.expenseItemEnumCollection=new a.Collection(s);let o=[];Object.entries(this.attributeDescription.expense_currency_code.enum).forEach(([e,{text:t,inactive:i}])=>{if(i)return;let n=t.match(/^(.+?)\|(.+)/);o.push({id:e,sign:n[1],text:n[2]})}),this.expenseCurrencyEnumCollection=new a.Collection(o);let l=[];Object.entries(this.attributeDescription.part_service_activity_used.enum).forEach(([e,{text:t,inactive:i}])=>{i||l.push({id:e,text:t})}),this.partActivityUsedEnumCollection=new a.Collection(l);let d=[];Object.entries(this.attributeDescription.part_service_activity_returned.enum).forEach(([e,{text:t,inactive:i}])=>{i||d.push({id:e,text:t})}),this.partActivityReturnedEnumCollection=new a.Collection(d);let h=this.openData().resource;this.resource=new e.Model({id:h.pid||"",name:h.pname||""});let m=this.openData().activity;this.customer=new e.Model({name:m.cname||"",address:m.caddress||"",city:m.ccity||"",state:m.cstate||"",zip:m.czip||"",workorder:m.appt_number||"",company:m.ccompany||""}),this.ofscActivityModel=new(e.Model.extend({idAttribute:"aid"}))({aid:m.aid});let _=this.openData().inventoryList;this.installedInventoriesSummary={},this.deinstalledInventoriesSummary={},Object.entries(_).forEach(([e,t])=>{if(!m.aid||!t.inv_aid||m.aid===String(t.inv_aid))if(c===t.invtype||v===t.invtype){let i=t.invpool;switch(t.part_item_number=t.part_item_number_rev+"~"+t.invsn,null===t.quantity&&(t.quantity=0),i){case"provider":this.resourcePartsCollection.add(t);break;case"customer":this.customerPartsCollection.add(t);break;case"install":let n=t.part_item_number_rev;""!==t.invsn&&(n=n+"~"+t.invsn),this.installedInventoriesSummary[n]={invid:t.invid,model:t.part_item_number_rev,quantity_delta:0,invsn:t.invsn},this.usedPartsCollection.add(t);break;case"deinstall":let r=t.part_item_number_rev;""!==t.invsn&&(r=r+"~"+t.invsn),this.deinstalledInventoriesSummary[r]={invid:t.invid,model:t.part_item_number_rev,quantity_delta:0,invsn:t.invsn},this.returnedPartsCollection.add(t);break;default:throw new Error(`Unknown inventory pool: '${i}' (invid = '${e}')`)}}else u===t.invtype?this.addLabor({activityId:t.labor_service_activity,itemId:t.labor_item_number,startTime:t.labor_start_time,endTime:t.labor_end_time,recordId:e}):p===t.invtype&&this.addExpense({activityId:t.expense_service_activity,itemId:t.expense_item_number,amount:t.expense_amount,currencyKey:t.expense_currency_code,recordId:e})}),null!=this.openData().securedData&&this.logoUrl(this.openData().securedData.logoUrl),this.timeConverter=new e.IntlDateTimeConverter({pattern:"hh:mm a"}),this.inventorySearchService=new n(this.resourcePartsCollection,this.attributeDescription,["part_item_number_rev","part_item_desc","invsn"],"part_item_number_rev")}getIdFromArray(e){let t=0;return 0===e.length?t=1:(e.forEach(e=>{t=t<=e.id?e.id:t}),t++),t}addLabor({activityId:e,itemId:t,startTime:i,endTime:n,recordId:r=null}){let s={id:this.getIdFromArray(this.laborItems()),activityId:e,itemId:t,startTime:i,endTime:n};r&&(s.recordId=r),Object.entries(this.laborItemEnumCollection.get(t).toJSON()).forEach(([e,t])=>{s["item_"+e]=t}),Object.entries(this.laborActivityEnumCollection.get(e).toJSON()).forEach(([e,t])=>{s["activity_"+e]=t});let o=this.dateTimeConverter.compareISODates(this.dateTimeConverter.parse(n),this.dateTimeConverter.parse(i))/1e3/60;s.duration=o<0?+o+1440:o,this.laborItems.push(s)}removeLabor(e){const t=this.laborItems().findIndex(t=>t.id===e),i=this.laborItems.splice(t,1).filter(e=>!!e.recordId);i.length&&this.addInventoryListToDeleted(i)}addExpense({activityId:e,itemId:t,amount:i,currencyKey:n,recordId:r}){let s={id:this.getIdFromArray(this.expenseItems()),activityId:e,itemId:t,amount:i,currencyKey:n};r&&(s.recordId=r),Object.entries(this.expenseItemEnumCollection.get(t).toJSON()).forEach(([e,t])=>{s["item_"+e]=t}),Object.entries(this.expenseActivityEnumCollection.get(e).toJSON()).forEach(([e,t])=>{s["activity_"+e]=t}),Object.entries(this.expenseCurrencyEnumCollection.get(n).toJSON()).forEach(([e,t])=>{s["currency_"+e]=t}),this.expenseItems.push(s)}removeExpense(e){const t=this.expenseItems().findIndex(t=>t.id===e),i=this.expenseItems.splice(t,1).filter(e=>!!e.recordId);i.length&&this.addInventoryListToDeleted(i)}checkValidationGroup(){const e=document.getElementById("tracker");return"valid"===e.valid||(e.showMessages(),e.focusOn("@firstInvalidShown"),!1)}submitPluginData(){this.ofscConnector.sendMessage(this._getOfscCloseData()).then(e=>{console.log("RESPONSE DATA: ",e)}).catch(e=>{this._showErrorAlert(e),console.error(e)})}addUsedPart(e,t,i,n){let r=this.resourcePartsCollection.findWhere({part_item_number_rev:e,invsn:n}),s="";if(s=n?e+"~"+n:e,!r)return!1;let o=this.usedPartsCollection.findWhere({part_item_number_rev:e,invsn:n});if(!o){let e=r.toJSON();delete e.invid,e.quantity=0,e.invpool="install",e.invsn=n,o=new this.partModelConstructor(e),this.usedPartsCollection.add(o)}r.set("quantity",(parseInt(r.get("quantity"),10)||0)-i),o.set("quantity",(parseInt(o.get("quantity"),10)||0)+i),o.set("part_service_activity_used",t);let a=this.installedInventoriesSummary[s];a||(a=this.installedInventoriesSummary[s]={invid:null,model:e,activityId:t,quantity_delta:0,serialNum:n}),a.quantity_delta+=i}removeUsedPart(e,t){let i=this.resourcePartsCollection.findWhere({part_item_number_rev:e,invsn:t}),n=this.usedPartsCollection.findWhere({part_item_number_rev:e,invsn:t});if(!n)return!1;let r=parseInt(n.get("quantity"),10)||0;if(!i){let e=n.toJSON();delete e.invid,e.quantity=0,e.invpool="provider",i=new this.partModelConstructor(e),this.resourcePartsCollection.add(i)}i.set("quantity",(parseInt(i.get("quantity"),10)||0)+r),n.set("quantity",(parseInt(n.get("quantity"),10)||0)-r);let s=this.installedInventoriesSummary[e];s||(s=this.installedInventoriesSummary[e]={invid:n.get("invid"),model:e,quantity_delta:0}),s.quantity_delta-=r}addReturnedPart(e,t,i,n){let r=e.get("part_item_number_rev"),s=this.customerPartsCollection.findWhere({part_item_number_rev:r,invsn:n}),o=this.returnedPartsCollection.findWhere({part_item_number_rev:r,invsn:n});if(n&&(r=r+"~"+n),!o){let t=e.toJSON();delete t.invid,t.quantity=0,t.invpool="deinstall",t.invsn=n,(o=new this.partModelConstructor(t)).set("part_item_number",r),this.returnedPartsCollection.add(o)}if(s)s.set("quantity",(parseInt(s.get("quantity"),10)||0)-i);else{let t=this.createdDeinstalledPartsCollection.findWhere({part_item_number_rev:e.get("part_item_number_rev"),invsn:n});t?t.set("quantity",(parseInt(t.get("quantity"),10)||0)+i):(e.set("quantity",parseInt(i,10)||0),e.set("part_item_number",r),this.createdDeinstalledPartsCollection.add(e))}o.set("quantity",(parseInt(o.get("quantity"),10)||0)+i),o.set("part_service_activity_returned",t);let a=this.deinstalledInventoriesSummary[r];a||(a=this.deinstalledInventoriesSummary[r]={invid:null,model:e.get("part_item_number_rev"),activityId:t,quantity_delta:0,invsn:n}),a.quantity_delta+=i}removeReturnedPart(e,t){let i=e,n=this.customerPartsCollection.findWhere({part_item_number_rev:e,invsn:t}),r=this.returnedPartsCollection.findWhere({part_item_number_rev:e,invsn:t});if(!r)return!1;let s=parseInt(r.get("quantity"),10)||0;if(!n){let e=r.toJSON();delete e.invid,e.quantity=0,e.invpool="customer",e.invsn=t,n=new this.partModelConstructor(e),this.customerPartsCollection.add(n)}n.set("quantity",(parseInt(n.get("quantity"),10)||0)+s),r.set("quantity",(parseInt(r.get("quantity"),10)||0)-s),t&&(i=i+"~"+t);let o=this.deinstalledInventoriesSummary[i];o||(o=this.deinstalledInventoriesSummary[i]={invid:r.get("invid"),model:e,quantity_delta:0,invsn:t}),o.quantity_delta-=s}_addInstallInventoryAction({invid:e,inv_aid:t,invsn:i,quantity:n,properties:r}){this.partsInventoryActionsCollection.add({action:"install",invid:e,inv_aid:t,invsn:i,quantity:n,properties:r||{}})}_addDeinstallInventoryAction({invid:e,inv_pid:t,quantity:i,properties:n}){this.partsInventoryActionsCollection.add({action:"deinstall",invid:e,inv_pid:t,quantity:i,properties:n||{}})}_createDeinstallInventoryAction(e,t={}){let i=e.toJSON();i.part_item_number.split("~")[0],delete i.invid,delete i.inv_aid,delete i.inv_pid,delete i.quantity,delete i.invpool,delete i.invtype,delete i.invsn,e.get("invtype")===v?this.partsInventoryActionsCollection.add({action:"create",entity:"inventory",inv_aid:e.get("inv_aid"),inv_pid:e.get("inv_pid"),invtype:e.get("invtype"),invpool:e.get("invpool"),properties:Object.assign(i||{},t)}):this.partsInventoryActionsCollection.add({action:"create",entity:"inventory",inv_aid:e.get("inv_aid"),inv_pid:e.get("inv_pid"),invtype:e.get("invtype"),quantity:e.get("quantity"),invpool:e.get("invpool"),properties:Object.assign(i||{},t)})}_addUndoInstallInventoryAction({invid:e,quantity:t,invsn:i,properties:n}){this.partsInventoryActionsCollection.add({action:"undo_install",invid:e,quantity:t,invsn:i,properties:n||{}})}_addUndoDeinstallInventoryAction({invid:e,quantity:t,properties:i}){this.partsInventoryActionsCollection.add({action:"undo_deinstall",invid:e,quantity:t,properties:i||{}})}_generatePartsActions(){Object.entries(this.installedInventoriesSummary).forEach(([e,t])=>{let i=null;if(-1!==e.indexOf("~")){let t=[];e=(t=e.split("~"))[0],i=t[1]}if(t.quantity_delta>0){let n=this.resourcePartsCollection.findWhere({part_item_number_rev:e,invsn:i});if(!n||!n.get("invid"))return void console.error("Unable to locate resource part, part_item_number_rev = "+e);v===n.get("invtype")?this._addInstallInventoryAction({invid:n.get("invid"),inv_aid:this.ofscActivityModel.get("aid"),properties:{part_service_activity_used:t.activityId,invsn:t.serialNum}}):this._addInstallInventoryAction({invid:n.get("invid"),inv_aid:this.ofscActivityModel.get("aid"),quantity:t.quantity_delta,properties:{part_service_activity_used:t.activityId}})}else if(t.quantity_delta<0){let i=this.usedPartsCollection.findWhere({part_item_number_rev:e});if(!i||!i.get("invid"))return void console.error("Unable to undo install of inventory, part_item_number_rev = "+e);v===i.get("invtype")?this._addUndoInstallInventoryAction({invid:t.invid,invsn:t.serialNum}):this._addUndoInstallInventoryAction({invid:i.get("invid"),quantity:Math.abs(t.quantity_delta),invsn:t.serialNum})}}),Object.entries(this.deinstalledInventoriesSummary).forEach(([e,t])=>{let i=null;if(-1!==e.indexOf("~")){let t=[];e=(t=e.split("~"))[0],i=t[1]}if(t.quantity_delta>0){let n=this.customerPartsCollection.findWhere({part_item_number_rev:e,invsn:i}),r=!1,s={part_service_activity_returned:t.activityId,invsn:t.invsn};if(n&&n.get("invid"))r=!0;else{let n=this.createdDeinstalledPartsCollection.findWhere({part_item_number_rev:e,invsn:i});n?(t.invsn&&n.set("invtype",v),this._createDeinstallInventoryAction(n,s)):console.error("Unable to locate customer part, part_item_number_rev = "+e)}r&&(n.get("invtype")===v?this._addDeinstallInventoryAction({invid:n.get("invid"),inv_pid:this.resource.GetId(),properties:s}):this._addDeinstallInventoryAction({invid:n.get("invid"),inv_pid:this.resource.GetId(),quantity:t.quantity_delta,properties:s}))}else if(t.quantity_delta<0){let n=this.returnedPartsCollection.findWhere({part_item_number_rev:e,invsn:i});if(!n||!n.get("invid"))return void console.error("Unable to undo deinstall of inventory, part_item_number_rev = "+e);n.get("invtype")===v?this._addUndoDeinstallInventoryAction({invid:n.get("invid")}):this._addUndoDeinstallInventoryAction({invid:n.get("invid"),quantity:Math.abs(t.quantity_delta)})}})}_getOfscCloseData(){return this._generatePartsActions(),{method:"close",activity:this.ofscActivityModel.toJSON(),inventoryList:this._getOfscInventoryListUpdates(),actions:[].concat(this._getOfscPartsInventoryActions(),this._getOfscCreateLaborInventoryActions(),this._getOfscCreateExpenseInventoryActions(),this._getOfscDeleteInventoryActions())}}_getOfscInventoryListUpdates(){let e={};return this.partsInventoryActionsCollection.where({action:"update"}).forEach(t=>{e[t.get("invid")]=Object.assign({invid:t.get("invid"),invtype:t.get("invtype"),inv_aid:t.get("inv_aid"),inv_pid:t.get("inv_pid"),quantity:t.get("quantity")},t.properties)}),e}_getOfscPartsInventoryActions(){return this.partsInventoryActionsCollection.filter(e=>"update"!==e.get("action")).map(e=>Object.assign({entity:"inventory"},e.toJSON()))}_getOfscCreateLaborInventoryActions(){return this.laborItems().filter(e=>!e.recordId).map(e=>({entity:"inventory",action:"create",invpool:"install",invtype:u,inv_aid:this.ofscActivityModel.GetId(),inv_pid:this.resource.GetId(),properties:{labor_service_activity:e.activityId,labor_item_number:e.itemId,labor_item_desc:e.itemId,labor_start_time:e.startTime,labor_end_time:e.endTime}}))}_getOfscCreateExpenseInventoryActions(){return this.expenseItems().filter(e=>!e.recordId).map(e=>({entity:"inventory",action:"create",invpool:"install",invtype:p,inv_aid:this.ofscActivityModel.GetId(),inv_pid:this.resource.GetId(),properties:{expense_service_activity:e.activityId,expense_item_number:e.itemId,expense_item_desc:e.itemId,expense_amount:""+e.amount,expense_currency_code:e.currencyKey}}))}_getOfscDeleteInventoryActions(){const e=this.getDeletedInventoryList();return e.length?e.map(m):[]}_verifyProperties(e,t){let i=JSON.parse(e).properties,n=[];return Object.values(i).forEach(e=>{t[e.label]||n.push(e.label)}),n.length?1===n.length?"The following property must be configured: "+n[0]+".":"The following properties must be configured: "+n.join(", ")+".":""}_showErrorAlert(e){let t=e.errors.map(e=>{switch(e.code){case"CODE_ACTION_INVENTORY_ACTIVITY_STATUS_INVALID":return"The activity must be started";case"CODE_ACTION_ON_PAST_DATE_NOT_ALLOWED":return"The activity shouldn't be in the past";default:return e}});0!==t.length&&(1===(t=t.filter((e,t,i)=>i.findIndex(t=>["code"].every(i=>t[i]===e[i]))===t)).length&&"string"==typeof t[0]?this.errorAlertPopup("Critical Error",t.join(),""):this.errorAlertPopup("Critical Error",JSON.stringify(t,null,4),""))}errorAlertPopup(e,t){return this.resolveAlertCallback=null,this.dialogHeading(e),this.dialogMessage(t),document.getElementById("alertDialog").open(),new Promise((e,t)=>{this.resolveAlertCallback=e})}closeDialog(e){document.getElementById("alertDialog").close(),this.resolveAlertCallback instanceof Function&&this.resolveAlertCallback()}addInventoryListToDeleted(e){const t=this.getDeletedInventoryList();t.length?this.setDeleteInventoryList(t.concat(e)):this.setDeleteInventoryList(e)}setDeleteInventoryList(e){this.deleteInventoryList=e}getDeletedInventoryList(){return this.deleteInventoryList||[]}}});