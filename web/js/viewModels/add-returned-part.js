"use strict";define(["knockout","utils/dom","ojs/ojarraydataprovider","ojs/ojinputtext","ojs/ojinputnumber","ojs/ojlistview","ojs/ojformlayout","ojs/ojselectcombobox","ojs/ojvalidationgroup","ojs/ojinputsearch","utils/ko-text-highlighted-binding"],function(t,e,i){return function(){return new class{handleActivated(e){this._controller=e.valueAccessor().params.app,this.partActivityReturnedEnumCollection=this._controller.partActivityReturnedEnumCollection,this.activityId=t.observable(""),this.serialNum=t.observable(""),this.isSerialized=t.observable(!1),this.displayMoreButton=t.observable(!1),this.inventories=this._controller.customerPartsCollection.map(t=>this.getInventoryViewModel(t)).sort((t,e)=>{let i=t.inventory.get("part_item_number")||"",r=e.inventory.get("part_item_number")||"";return i.toString().localeCompare(r)}),this.inventoriesDataProvider=new oj.ArrayDataProvider(this.inventories,{idAttribute:"id"}),this.selectMessagesCustomBillingType=t.observable([]),this.isSearchByPartsCatalog=t.observable(!1),this.listViewSelection=t.observable([]),this.listViewSelection.subscribe(t=>{if(t&&1===t.length){let e=t[0],i=this.inventories.find(t=>t.id===e);i&&this.selectedInventory(i)}}),this.dataValidation={detail:"Enter a valid value.",summary:"",severity:"error"},this.selectedInventory=t.observable(null),this.selectedIventoryMeasureUnit=t.pureComputed(()=>{let t=this.selectedInventory();return t&&this._controller.attributeDescription.part_uom_code&&this._controller.attributeDescription.part_uom_code.enum&&t.inventory.get("part_uom_code")&&this._controller.attributeDescription.part_uom_code.enum[t.inventory.get("part_uom_code")]?this._controller.attributeDescription.part_uom_code.enum[t.inventory.get("part_uom_code")].text:""}),this.activityEnumArray=new i(this.partActivityReturnedEnumCollection.map(t=>({value:t.get("id"),label:t.get("text")})),{keyAttributes:"value"}),this.activityId(this.activityEnumArray.data[0].value),this.quantity=t.observable(1),this.searchRequest=t.observable(""),this.isSearchContinueAvailable=t.observable(!1),this.currentSearchId=t.observable(null),this.searchContinueLoading=t.observable(!1),this.isLoading=t.observable(!1),this.isSearchInProgress=t.observable(!1),this.searchResultItems=t.observableArray([]),this.currentSearchPromise=Promise.resolve(),this.noResults=t.pureComputed(()=>this.searchResultItems().length<=0),this._nextSearchRequest=null,this.searchRequestFiltered=t.pureComputed(()=>{let t=this.searchRequest();return(t=t.trim()).length<3?"":t}),this.partsCatalogDataService=this._controller.partsCatalogDataService,this.catalogCollection=this._controller.catalogCollection,this.searchRequestFiltered.subscribe(t=>{if(!t)return this._nextSearchRequest=null,this.clearSearchResults(),this.isLoading(!1),this.isSearchInProgress(!1),this.isSearchContinueAvailable(!1),this.searchContinueLoading(!1),void this.currentSearchId(null);this.isLoading(!0),this.isSearchInProgress(!0),null===this._nextSearchRequest?(this._nextSearchRequest=t,this.currentSearchPromise.then(()=>{let t=this._nextSearchRequest;if(!t)return Promise.resolve();this._nextSearchRequest=null;let e=[];return e.push(this.partsCatalogDataService.searchParts(t,10).then(t=>(this.isSearchContinueAvailable(t.isContinueAvailable),this.searchContinueLoading(!1),this.currentSearchId(t.searchId),this.searchResultItems(t.items),Promise.resolve()))),this.currentSearchPromise=Promise.all(e).then(()=>{this.isLoading(!1)}).catch(t=>{console.error(t),this.isLoading(!1)}),this.currentSearchPromise})):this._nextSearchRequest=t}),this.showSearchResults=t.pureComputed(()=>{let t=this.isSearchInProgress(),e=this.isLoading();return!(!t||e&&this.searchResultItems().length<=0&&!this.noResults())}),this.isSerialized=t.pureComputed(()=>this.serialNum().length>0),this.isSerialized.subscribe(t=>{this.quantity(1)})}clearSearchResults(){this.searchResultItems([])}continueSearch(){if(!this.isSearchContinueAvailable()||!this.currentSearchId()||this.searchContinueLoading())return!1;this.searchContinueLoading(!0);let t=this.currentSearchId();this.partsCatalogDataService.searchPartsContinue(t).then(e=>{this._disposed||this.currentSearchId()===t&&(this.searchContinueLoading(!1),this.searchResultItems(this.searchResultItems().concat(e.items)),this.isSearchContinueAvailable(e.isContinueAvailable),this.currentSearchId(e.searchId))})}partSelected(t){let e=t.fields.part_uom_code||"ea";this._controller.attributeDescription.part_uom_code&&this._controller.attributeDescription.part_uom_code.enum[e]||(e="ea");let i=t.fields.part_disposition_code||"N";this._controller.attributeDescription.part_disposition_code.enum[i]||(i="N");let r=new this._controller.partModelConstructor({part_item_number:""+t.fields.part_item_number||"",part_item_revision:""+t.fields.part_item_revision||"",part_item_number_rev:t.label,part_item_desc:t.fields.part_item_desc||"",part_uom_code:e,part_disposition_code:i,invtype:"part",invpool:"deinstall",inv_aid:this._controller.ofscActivityModel.get("aid"),inv_pid:this._controller.resource.get("id")});this.selectedInventory(this.getInventoryViewModel(r)),console.log("PART SELECTED: ",t)}searchAtPartsCatalog(){this.clearSearchResults(),this.searchRequest(""),this.isSearchByPartsCatalog(!0)}getInventoryViewModel(t){let e="";return this._controller.attributeDescription.part_uom_code&&this._controller.attributeDescription.part_uom_code.enum&&this._controller.attributeDescription.part_uom_code.enum[t.get("part_uom_code")]&&(e=this._controller.attributeDescription.part_uom_code.enum[t.get("part_uom_code")].text),""!==e&&(e=" "+e),{id:t.get("part_item_number_rev"),inventory:t,measuredQuantity:t.get("quantity")?`${t.get("quantity")}${e}`:"",dispositionText:t.get("part_disposition_code")&&this._controller.attributeDescription.part_disposition_code&&this._controller.attributeDescription.part_disposition_code.enum&&this._controller.attributeDescription.part_disposition_code.enum[t.get("part_disposition_code")]&&this._controller.attributeDescription.part_disposition_code.enum[t.get("part_disposition_code")].text}}submit(){const t=this._controller.checkValidationGroup(),e=""!==this.activityId&&this._validateBillingType(this.activityId);if(t&&!e&&this.selectMessagesCustomBillingType([this.dataValidation]),t&&e){let t=this.selectedInventory().inventory,e=this.quantity(),i=null;if(""!=this.serialNum()){i=this.serialNum(),e=1;let r=this._controller.returnedPartsCollection.findWhere({part_item_number_rev:t.get("part_item_number_rev"),invsn:i});if(r&&1==r.get("quantity"))return void this._controller.errorAlertPopup("Critical Error",t.get("part_item_number_rev")+"("+i+") is already added.")}t.set("invsn",i),this._controller.addReturnedPart(t,this.activityId(),e,i),this._controller.router.go("dashboard",{historyUpdate:"replace"})}}_validateBillingType(){return!!this.activityEnumArray.data.find(t=>t.value===this.activityId())}handleAttached(t){}handleBindingsApplied(t){e.resetScrolling()}handleDetached(t){}back(){this.selectedInventory()?this.selectedInventory(null):this.isSearchByPartsCatalog()?this.isSearchByPartsCatalog(!1):this.dismiss()}dismiss(){this.selectedInventory()?(this.listViewSelection([]),this.selectedInventory(null)):this._controller.router.go("dashboard",{historyUpdate:"replace"})}}}});