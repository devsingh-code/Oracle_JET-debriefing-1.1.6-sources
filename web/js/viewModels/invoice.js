define(["knockout","jquery","ojs/ojcore","../utils/signature","../utils/html-page","../utils/dom","ojs/ojknockout-model","ojs/ojdatetimepicker","ojs/ojcollectiontabledatasource"],function(t,e,i,r,n,o){const s='<div class="html2pdf__page-break"></div>',a=new n(1e3),l={jsPDF:{unit:"pt",format:"a4",orientation:"p"},margin:20,image:{type:"jpeg"},html2canvas:{useCORS:!0,scale:2}};return function(){return new class{constructor(){this.invoiceSignature=null,this.printableForm=null,this.printableFormId="printableForm",this.canvasID="canvas_invoice",this.canvasClearButtonID="button_clear_canvas",this.printableCanvasID="printableSignatureCanvas",this.fileName="pro_forma_invoice.pdf",this.handleActivated=function(e){this._controller=e.valueAccessor().params.app,this.laborItems=this._controller.laborItems,this.dateTimeConverter=this._controller.dateTimeConverter,this.timeConverter=this._controller.timeConverter,this._activityModel=this._controller.ofscActivityModel,this.customer=i.KnockoutUtils.map(this._controller.customer),this.resource=i.KnockoutUtils.map(this._controller.resource),this.logoUrl=this._controller.logoUrl(),this.isEmptyLogo=t.pureComputed(()=>this.logoUrl.length>0),this.totalHoursText=t.observable(""),this.laborsTotalHours=t.pureComputed(function(){let t=0;return this.laborItems().length>0&&this.laborItems().forEach(e=>{let i=(this.dateTimeConverter.compareISODates(this.dateTimeConverter.parse(e.endTime),this.dateTimeConverter.parse(e.startTime))/1e3/60/60).toFixed(2);i=i<0?+i+24:i,t+=parseFloat(i)}),this.totalHoursText("hrs"),t.toFixed(2)}.bind(this)),this.expenseItems=this._controller.expenseItems,this.currencySign=t.observable(""),this.totalExpensesAmount=t.pureComputed(function(){let t=0;return this.expenseItems().length>0&&this.expenseItems().forEach(e=>{t+=parseFloat(e.amount),this.currencySign(e.currency_sign)}),t}.bind(this)),this.stateCityText=t.pureComputed(function(){let t=this.customer.state(),e=this.customer.city();return t&&e?t+", "+e:t&&!e?t:!t&&e?e:""}.bind(this)),this.workOrderText=t.pureComputed(function(){let t=this.customer.workorder();return t?"WO"+t:""}.bind(this)),this.currentDate=t.pureComputed(function(){let t=new Date,e=t.getDate(),i=t.getMonth(),r=t.getFullYear();return e+" "+["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][i]+" "+r}.bind(this)),this.usedPartsList=this._controller.usedPartsCollection.filter(t=>t.get("quantity")>0).map(t=>this.getInventoryViewModel(t)).sort((t,e)=>{let i=t.inventory.get("part_item_number")||"",r=e.inventory.get("part_item_number")||"";return i.toString().localeCompare(r)}),this.returnedPartsList=this._controller.returnedPartsCollection.filter(t=>t.get("quantity")>0).map(t=>this.getInventoryViewModel(t)).sort((t,e)=>{let i=t.inventory.get("part_item_number")||"",r=e.inventory.get("part_item_number")||"";return i.toString().localeCompare(r)})},this.handleAttached=function(t){this.printableForm=document.getElementById(this.printableFormId),this._initSignature()},this.handleBindingsApplied=function(t){o.resetScrolling()},this.handleDetached=function(t){this.invoiceSignature=null}}getInventoryViewModel(t){let e="";return this._controller.attributeDescription.part_uom_code&&this._controller.attributeDescription.part_uom_code.enum&&this._controller.attributeDescription.part_uom_code.enum[t.get("part_uom_code")]&&(e=this._controller.attributeDescription.part_uom_code.enum[t.get("part_uom_code")].text),""!==e&&(e=" "+e),{id:t.get("part_item_number_rev"),inventory:t,measuredQuantity:`${t.get("quantity")}${e}`,dispositionText:t.get("part_disposition_code")&&this._controller.attributeDescription.part_disposition_code&&this._controller.attributeDescription.part_disposition_code.enum&&this._controller.attributeDescription.part_disposition_code.enum[t.get("part_disposition_code")]&&this._controller.attributeDescription.part_disposition_code.enum[t.get("part_disposition_code")].text}}formatDuration(t){let e=t.startTime,i=t.endTime,r="";r="hrs";let n=(this.dateTimeConverter.compareISODates(this.dateTimeConverter.parse(i),this.dateTimeConverter.parse(e))/1e3/60/60).toPrecision(2);return(n=n<0?+n+24:n)+" hrs"}formatTime(t){return this.timeConverter.format(t)}_initSignature(){let t=document.getElementById(this.canvasID),e=function(){},i=document.getElementById(this.canvasClearButtonID);this.invoiceSignature=new r(t,i,!1),i.signature=this.invoiceSignature,t.signature=this.invoiceSignature,i&&(i.addEventListener("click",function(){this.signature.clear()},!1),t.addEventListener("mouseup",e),t.addEventListener("touchend",e),t.addEventListener("pointerup",e))}onCloseButtonClick(){this._controller.router.go("dashboard",{historyUpdate:"replace"})}onSubmitButtonClick(){this.copySignatureCanvasToPrintableElementAsImage(),this.insertPageBreaks(this.printableForm),this.generatePDF()}copySignatureCanvasToPrintableElementAsImage(){let t=document.getElementById(this.printableCanvasID).getContext("2d");t.scale(.5,.5),t.canvas.width=450,t.canvas.height=300,t.drawImage(document.getElementById(this.canvasID),0,0)}insertPageBreaks(t,e=0,i=0){const r=t.children,n=2===i;let l=Number(e);return[...r].forEach(t=>{const e=0===i?t.offsetHeight:o.offsetHeightWithMargin(t),r=l+e;a.isExceedPageHeight(e)&&!n?l=this.insertPageBreaks(t,l,i+1):a.isExceedPageHeight(r)&&!n?l=this.insertPageBreaks(t,l,i+1):a.isExceedPageHeight(r)&&n?(o.insertHTMLBeforeElement(s,t),l=a.remainingPageHeight(e)):l=a.remainingPageHeight(r)}),l}generatePDF(){html2pdf().from(this.printableForm).set(l).outputPdf("blob").then(t=>{this.saveForm(new Blob([t],{type:"application/pdf"}))})}saveForm(t){this.setActivityModelInvoice(t),this.invoiceSignature.isEmpty()||this.setActivityModelSignature(this.invoiceSignature.getDataString()),this._controller.submitPluginData()}setActivityModelInvoice(t){this._activityModel.set("invoice",{fileName:this.fileName,fileContents:t})}setActivityModelSignature(t){this._activityModel.set("csign",t)}}}});